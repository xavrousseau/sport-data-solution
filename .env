# ==========================================================================================
# FICHIER : .env
# OBJET   : Variables de configuration centralisées — Sport Data Solution
# AUTEUR  : Xavier Rousseau — Mis à jour Août 2025
# ==========================================================================================

############################################################################################
# [0] Redis — Message broker (utilisé par Airflow via Celery)
############################################################################################
REDIS_HOST=sport-redis
REDIS_PORT=6379

############################################################################################
# [1] PostgreSQL — Base de données principale
############################################################################################
POSTGRES_HOST=sport-postgres
POSTGRES_PORT=5432
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_DB=sportdata

############################################################################################
# [2] MinIO — Stockage objet S3-compatible (données projets)
############################################################################################
MINIO_HOST=sport-minio
MINIO_PORT=9000
MINIO_CONSOLE_PORT=9001
MINIO_ROOT_USER=minio
MINIO_ROOT_PASSWORD=minio123
MINIO_BUCKET_NAME=sportdata
MINIO_PROMETHEUS_AUTH_TYPE=public
# Endpoint HTTP explicite (utilisé par les jobs Spark)
MINIO_ENDPOINT=http://sport-minio:9000

############################################################################################
# [3] Redpanda — Plateforme de streaming Kafka-compatible
############################################################################################
REDPANDA_HOST=sport-redpanda
REDPANDA_BROKER_PORT=9092
REDPANDA_ADMIN_PORT=9644
REDPANDA_CONSOLE_PORT=8085
# Bootstrap utilisé par les jobs Spark
KAFKA_BOOTSTRAP_SERVERS=sport-redpanda:9092

############################################################################################
# [4] Debezium — Change Data Capture (CDC) via Kafka
############################################################################################
DEBEZIUM_CONNECT_PORT=8083
DEBEZIUM_BOOTSTRAP_SERVERS=sport-redpanda:9092
DEBEZIUM_GROUP_ID=1
DEBEZIUM_CONFIG_STORAGE_TOPIC=debezium_configs
DEBEZIUM_OFFSET_STORAGE_TOPIC=debezium_offsets
DEBEZIUM_STATUS_STORAGE_TOPIC=debezium_statuses
#DEBEZIUM_CONNECT_REST_ADVERTISED_HOST_NAME=connect
CDC_SCHEMA=sportdata
CDC_PUBLICATION=debezium_publication

############################################################################################
# [5] Spark — Ingestion Bronze (UNIFIÉE : etape_08_spark_bronze_controle_qualite.py)
############################################################################################
SPARK_HOST=sport-spark
SPARK_MODE=master
SPARK_CLUSTER_PORT=7077
SPARK_UI_PORT=4040

# Topic Kafka des activités (source)
KAFKA_TOPIC=sportdata.sportdata.activites_sportives
# Paramètres consommation Kafka streaming
KAFKA_STARTING_OFFSETS=latest          # latest / earliest / JSON
KAFKA_MAX_OFFSETS_PER_TRIGGER=20000

# CIBLE BRONZE **TABLE DELTA** (⚠️ ne pas pointer la racine /bronze/)
DELTA_PATH_ACTIVITES=s3a://sportdata/bronze/activites_sportives
# Quarantine (Delta) & DLQ parse
DELTA_PATH_QUARANTINE=s3a://sportdata/quarantine/activites_sportives
DELTA_PATH_ACTIVITES_DLQ_PARSE=s3a://sportdata/bronze/_errors/activites_sportives_parse

# Checkpoint streaming (versionne si tu changes le plan)
CHECKPOINT_PATH_DELTA_QC=s3a://sportdata/bronze/_checkpoints/activites_qc_v1
RESET_CHECKPOINT=false                 # true pour reset local (évite S3A ici)

# Tuning écriture Delta / cadence
DELTA_COALESCE_TARGET=1                # 1 = gros fichiers
DELTA_MAX_RECORDS_PER_FILE=500000
SPARK_SQL_SHUFFLE_PARTITIONS=4
STREAM_TRIGGER_SECONDS=30
APP_NAME_QC=BronzeIngestionQC          # Nom d'app Spark (logs)

# Scripts (pour DAGs / wrappers)
SPARK_CONTAINER_NAME=sport-spark
SPARK_SCRIPT_CONTROLE_PATH=/opt/bitnami/spark/jobs/etape_08_spark_bronze_controle_qualite.py
# (obsolète si unifié) SPARK_SCRIPT_STREAMING_PATH=/opt/bitnami/spark/jobs/bronze_streaming_activites.py

############################################################################################
# [6] ntfy — Notifications REST
############################################################################################
NTFY_HTTP_PORT=8080
NTFY_URL=http://sport-ntfy:80
NTFY_URL_DEFAULT=http://sport-ntfy:80
NTFY_ENABLED=true                      # coupe toutes les notifs si false
NTFY_ENABLED_ACTIVITES=true            # override spécifique ingestion activités
NTFY_MAX_PER_BATCH=200                 # plafond par micro-batch (anti-spam)
NTFY_TOPIC=sportdata_activites         # topic pour les activités
NTFY_TOPIC_PRIMES_JBE=avantages_sportifs
NTFY_DEBOUNCE_SECONDS=60               # anti-doublons côté job primes/JBE (résumés)

############################################################################################
# [7] Monitoring — Prometheus + Grafana
############################################################################################
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000

############################################################################################
# [8] Airflow — Orchestration de workflows
############################################################################################
AIRFLOW__CORE__FERNET_KEY=DcDt5DtguoXRfVACBP9SLhiU9kx_Hk7r53F0kAgOCsc=
AIRFLOW__WEBSERVER__SECRET_KEY=DcDt5DtguoXRfVACBP9SLhiU9kx_Hk7r53F0kAgOCsc=
AIRFLOW__CORE__EXECUTOR=CeleryExecutor
AIRFLOW__CELERY__BROKER_URL=redis://${REDIS_HOST}:${REDIS_PORT}/0
AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
AIRFLOW__WEBSERVER__SESSION_BACKEND=securecookie
AIRFLOW__WEBSERVER__SESSION_LIFETIME_SECONDS=3600

############################################################################################
# [9] DBT — Data Build Tool (transformation SQL)
############################################################################################
DBT_TARGET=dev
PGHOST=${POSTGRES_HOST}
PGPORT=${POSTGRES_PORT}
PGUSER=${POSTGRES_USER}
PGPASSWORD=${POSTGRES_PASSWORD}
PGDATABASE=${POSTGRES_DB}
DBT_PROFILES_DIR=/usr/app

############################################################################################
# [10] Metabase — Interface BI
############################################################################################
METABASE_PORT=3001
MB_TIMEZONE=Europe/Paris

############################################################################################
# [11] pgAdmin — Interface web pour PostgreSQL
############################################################################################
PGADMIN_DEFAULT_EMAIL=admin@sportdata.fr
PGADMIN_DEFAULT_PASSWORD=admin
PGADMIN_PORT=5050
PGADMIN_LISTEN_PORT=80

############################################################################################
# [12] Google Maps API — Pour géocodage et calcul de distance
############################################################################################
GOOGLE_API_KEY=AIzaSyAdIGjXTvfuPS-lHPborXFL-Hc3WjBpPIg

############################################################################################
# [13] Simulation d’activités sportives (scripts init)
############################################################################################
SIMULATION_MONTHS=1
SIMULATION_MIN_ACTIVITIES=1
SIMULATION_MAX_ACTIVITIES=15

############################################################################################
# [14] Répertoires de données (structure MinIO harmonisée)
############################################################################################
MINIO_PATH_INPUTS=inputs/
MINIO_PATH_CLEAN=clean/
MINIO_PATH_BRONZE=bronze/
MINIO_PATH_SILVER=silver/
MINIO_PATH_GOLD=gold/
MINIO_PATH_EXPORTS=exports/
MINIO_PATH_VALIDATION=validation/
INPUT_DATA_PATH=/opt/airflow/data/inputs
OUTPUT_DATA_PATH=/opt/airflow/data/outputs
EXPORT_DATA_PATH=/opt/airflow/data/exports
SCRIPTS_PATH=/opt/airflow/scripts

############################################################################################
# [15] Contrôles de qualité dans les DAGs/scripts
############################################################################################
ENABLE_QUALITY_CHECKS=True
RAISE_ON_DISTANCE_ERROR=False

############################################################################################
# [16] Export Power BI — Format & table cible
############################################################################################
EXPORT_FORMAT=csv
POWERBI_EXPORT_TABLE=avantages_sportifs_export
# Exports utilisés par le job Gold (#10)
EXPORT_MINIO_CSV=exports/avantages_sportifs.csv
EXPORT_MINIO_GE_REPORT=exports/rapport_ge_silver.html
GE_STRICT_FAIL=true

############################################################################################
# [17] Activation du job Spark streaming (via DAG conditionnel)
############################################################################################
LANCER_STREAMING=True

############################################################################################
# [18] Primes sportives & Journées bien-être — Calcul & Streaming (jobs 04 & 09)
############################################################################################
SEUIL_ACTIVITES_PRIME=10
POURCENTAGE_PRIME=0.05
NB_JOURNEES_BIEN_ETRE=5
MINIO_RH_KEY=clean/donnees_rh_cleaned.xlsx
MINIO_SPORT_KEY=clean/activites_sportives_simulees.xlsx
MINIO_EXPORT_PRIMES=gold/beneficiaires_primes_sportives.xlsx
MINIO_EXPORT_BE=gold/beneficiaires_journees_bien_etre.xlsx

# Topics de publication
KAFKA_TOPIC_PRIMES=sportdata.sportdata.beneficiaires_primes_sport
KAFKA_TOPIC_JBE=sportdata.sportdata.beneficiaires_journees_bien_etre

# Bronze Delta primes/JBE (lu par le Gold, écrit par le streaming #09)
DELTA_BASE_PRIMES_JBE=s3a://sportdata/bronze_primes_jbe

# Checkpoint du flux primes/JBE
CHECKPOINT_PATH_PRIMES_JBE=s3a://sportdata/bronze/_checkpoints/primes_jbe_v1

############################################################################################
# [19] Silver/Gold — sorties (job 10)
############################################################################################
DELTA_SILVER_ACTIVITES=s3a://sportdata/silver/activites_sportives
DELTA_GOLD_HEBDO=s3a://sportdata/gold/agg_hebdo
DELTA_GOLD_MENSUEL=s3a://sportdata/gold/agg_mensuel
DELTA_GOLD_INDICATEURS=s3a://sportdata/gold/indicateurs

# Référentiel RH (Delta) — optionnel (le Gold s’adapte si absent)
DELTA_RH_CLEAN_PATH=s3a://sportdata/referentiels/donnees_rh_cleaned/

# ==========================================================================================
# FIN DU FICHIER — .env
# ==========================================================================================
