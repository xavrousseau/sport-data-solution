# ====================================================================================
# FICHIER   : docker/docker-compose.override.dbt.yml
# OBJET     : DÃ©ploiement de DBT (modÃ©lisation et transformation de donnÃ©es SQL)
# CONTEXTE  : Utilise lâ€™image officielle dbt-postgres, reliÃ©e Ã  PostgreSQL local
# ====================================================================================

services:

  # -------------------------------------------------------------------------------
  # ğŸ§± Service DBT â€” Transformation et modÃ©lisation SQL orientÃ©e analytique
  # -------------------------------------------------------------------------------
  sport-dbt:
    image: ghcr.io/dbt-labs/dbt-postgres:1.7.13
    container_name: sport-dbt

    working_dir: /usr/app  # ğŸ“ RÃ©pertoire de travail DBT Ã  lâ€™intÃ©rieur du conteneur

    volumes:
      # ğŸ“¦ Montage du projet DBT local
      - ./dbt:/usr/app

      # âš™ï¸ Fichier profiles.yml avec les connexions DBT (standard ~/.dbt/profiles.yml)
      - ./dbt/profiles.yml:/root/.dbt/profiles.yml

    environment:
      # ğŸ“‚ RÃ©pertoire du profile DBT
      DBT_PROFILES_DIR: /root/.dbt

      # ğŸ”‘ Connexion Ã  PostgreSQL (injectÃ©e depuis .env)
      PGHOST: ${PGHOST}
      PGPORT: ${PGPORT}
      PGUSER: ${PGUSER}
      PGPASSWORD: ${PGPASSWORD}
      PGDATABASE: ${PGDATABASE}

      # ğŸ¯ Cible active du projet (ex : dev, prodâ€¦)
      DBT_TARGET: ${DBT_TARGET}

    # âœ… Garde le conteneur actif sans gÃ©nÃ©rer dâ€™erreur liÃ©e Ã  une commande shell inexistante
    entrypoint: ["sleep", "infinity"]

    healthcheck:
      # â¤ï¸ VÃ©rifie que la CLI DBT fonctionne correctement
      test: ["CMD-SHELL", "dbt --version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

    depends_on:
      sport-postgres:
        condition: service_healthy  # âœ… Attend que PostgreSQL soit prÃªt

    restart: unless-stopped  # ğŸ” RedÃ©marre sauf en cas dâ€™arrÃªt manuel

    networks:
      - sport-network  # ğŸŒ RÃ©seau partagÃ© avec les autres services

# -------------------------------------------------------------------------------
# ğŸŒ RÃ©seau Docker partagÃ© pour lâ€™ensemble de la stack
# -------------------------------------------------------------------------------
networks:
  sport-network:
    driver: bridge
